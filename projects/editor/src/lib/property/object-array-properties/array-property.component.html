<editor-tree-item
    class="cursor-pointer"
    *ngIf="!isSimplified; else simplifiedView"
    [treeLevel]="treeLevel"
    [(isExpanded)]="isExpanded"
    [isExpandable]="true"
    [hasOptions]="hasOptions"
    [optionsMenu]="optionsMenu"
>
    <span
        headerContent
        class="property-key"
    >
        <span
            #key
            class="keyField"
            [ngClass]="{ editable: !!property.isKeyEditable }"
            [contentEditable]="!!property.isKeyEditable"
        >
        </span>
        <span>{{ '[ ' + childProperties.length + ' ]' }}</span>
    </span>

    <ng-container childrenContent>
        <ng-container *ngTemplateOutlet="childPropertiesView"></ng-container>
    </ng-container>
</editor-tree-item>

<ng-template #simplifiedView>
    <div
        class="simplified-header"
        (click)="isExpanded = !isExpanded"
    >
        <span class="simplified-header-left">
            <button
                mat-icon-button
                (click)="isExpanded = !isExpanded; $event.stopPropagation()"
            >
                <mat-icon
                    class="expand-icon"
                    [class.expanded-90]="isExpanded"
                    >chevron_right</mat-icon
                >
            </button>
            <span>{{ property.name ? property.name : property.key + ' [ ' + childProperties.length + ' ]' }}</span>
        </span>

        <button
            *ngIf="canAdd"
            mat-icon-button
            (click)="onAddChild(); $event.stopPropagation()"
        >
            <mat-icon>add</mat-icon>
        </button>
    </div>
    <div
        class="simplified-properties"
        *ngIf="isExpanded"
    >
        <ng-container *ngTemplateOutlet="childPropertiesView"></ng-container>
        <button
            *ngIf="canAdd"
            mat-button
            (click)="onAddChild()"
        >
            <mat-icon>add</mat-icon>
            <span>Add</span>
        </button>
    </div>
</ng-template>

<ng-template #childPropertiesView>
    <ng-container *ngFor="let child of childProperties; let i = index; let last = last; trackBy: trackPropertyByKey">
        <ng-container [ngSwitch]="child.type">
            <editor-object-property
                *ngSwitchCase="typeofProperty.OBJECT"
                [treeLevel]="childrenTreeLevel"
                [path]="getChildPath(child.key)"
                [target]="target"
                [property]="propertyService.getAsObjectProperty(child)"
                [isSimplified]="isSimplified"
                (remove)="onRemoveChild(i)"
                (targetChanged)="targetChanged.emit($event)"
            >
            </editor-object-property>

            <editor-boolean-property
                *ngSwitchCase="typeofProperty.BOOLEAN"
                [treeLevel]="childrenTreeLevel"
                [path]="getChildPath(child.key)"
                [property]="child"
                [target]="target"
                [isSimplified]="isSimplified"
                (remove)="onRemoveChild(i)"
                (targetChanged)="targetChanged.emit($event)"
            >
            </editor-boolean-property>

            <editor-chip-list-property
                *ngSwitchCase="typeofProperty.CHIP_LIST"
                [treeLevel]="childrenTreeLevel"
                [path]="getChildPath(child.key)"
                [property]="propertyService.getAsChiplistProperty(child)"
                [target]="target"
                [isSimplified]="isSimplified"
                (remove)="onRemoveChild(i)"
                (targetChanged)="targetChanged.emit($event)"
            >
            </editor-chip-list-property>

            <editor-textarea-property
                *ngSwitchCase="typeofProperty.TEXTAREA"
                [treeLevel]="childrenTreeLevel"
                [path]="getChildPath(child.key)"
                [property]="propertyService.getAsTextareaProperty(child)"
                [target]="target"
                [isSimplified]="isSimplified"
                (remove)="onRemoveChild(i)"
                (targetChanged)="targetChanged.emit($event)"
            >
            </editor-textarea-property>

            <ng-container *ngSwitchCase="typeofProperty.NUMBER">
                <ng-container *ngTemplateOutlet="inputProperty"></ng-container>
            </ng-container>
            <ng-container *ngSwitchCase="typeofProperty.TEXT">
                <ng-container *ngTemplateOutlet="inputProperty"></ng-container>
            </ng-container>
            <ng-template #inputProperty>
                <editor-input-property
                    [treeLevel]="childrenTreeLevel"
                    [path]="getChildPath(child.key)"
                    [property]="propertyService.getAsInputProperty(child)"
                    [target]="target"
                    [isSimplified]="isSimplified"
                    (remove)="onRemoveChild(i)"
                    (targetChanged)="targetChanged.emit($event)"
                >
                </editor-input-property>
            </ng-template>
        </ng-container>
        <mat-divider *ngIf="isSimplified && !last"></mat-divider>
    </ng-container>
</ng-template>

<mat-menu #optionsMenu="matMenu">
    <button
        *ngIf="canAdd"
        mat-menu-item
        (click)="onAddChild()"
    >
        <mat-icon>add</mat-icon>
        <span>Add {{ property.childProperty.type }}</span>
    </button>
    <button
        *ngIf="property.isRemovable"
        mat-menu-item
        (click)="remove.emit()"
    >
        <mat-icon>remove</mat-icon>
        <span>Remove</span>
    </button>
</mat-menu>
