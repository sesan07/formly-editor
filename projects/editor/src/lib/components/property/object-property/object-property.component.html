<lib-tree-item-header 
    class="cursor-pointer"
    *ngIf="!isSimplified else simplifiedView"
    [treeLevel]="treeLevel"
    [(isExpanded)]="isExpanded"
    [isExpandable]="true"
    [hasOptions]="hasOptions"
    [optionsMenu]="optionsMenu"
    >
    <span class="property-key">
        <span #key 
            class="keyField" 
            [ngClass]="{ 'editable': !!property.isKeyEditable }"
            [contentEditable]="!!property.isKeyEditable"
            (click)="onKeyClicked($event)">
        </span>
        <span>{{ (property?.name ? '(' + property.name + ') ' : '') + '{ ' + property.childProperties.length + ' }' }}</span>
    </span>
</lib-tree-item-header>

<div *ngIf="!isSimplified" [class.hidden]="!isExpanded">
    <ng-container *ngTemplateOutlet="childPropertiesView"></ng-container>
</div>

<ng-template #simplifiedView>
    <div class="simplified-container">
        <div class="simplified-properties">
            <ng-container *ngTemplateOutlet="childPropertiesView"></ng-container>
            <button *ngIf="canAdd" mat-button [matMenuTriggerFor]="addMenu">
                <mat-icon>add</mat-icon>
                <span>Add</span>
            </button>
        </div>
        <button *ngIf="property?.isRemovable" mat-icon-button color="warn" (click)="remove.emit()">
            <mat-icon>remove</mat-icon>
        </button>
    </div>
</ng-template>


<ng-template #childPropertiesView>
	<ng-container *ngFor="let child of property.childProperties; let i = index; trackBy: trackPropertyByKey">
        <ng-container *ngIf="isSimplified ? child.isSimple : true">
            <ng-container [ngSwitch]="child.type">
                <lib-array-property 
                    *ngSwitchCase="propertyType.ARRAY"
                    [treeLevel]="treeLevel + 1"
                    [target]="childrenTarget"
                    [property]="propertyService.getAsArrayProperty(child)"
                    [isSimplified]="isSimplified"
                    (remove)="onRemoveChild(i)"
                    (targetChanged)="targetChanged.emit()">
                </lib-array-property>
            
                <lib-object-property
                    *ngSwitchCase="propertyType.OBJECT"
                    [treeLevel]="treeLevel + 1"
                    [target]="childrenTarget"
                    [property]="propertyService.getAsObjectProperty(child)"
                    [isSimplified]="isSimplified"
                    (remove)="onRemoveChild(i)"
                    (targetChanged)="targetChanged.emit()">
                </lib-object-property>
            
                <lib-boolean-property
                    *ngSwitchCase="propertyType.BOOLEAN"
                    [treeLevel]="treeLevel + 1"
                    [property]="property"
                    [target]="childrenTarget"
                    [isSimplified]="isSimplified"
                    (remove)="onRemoveChild(i)"
                    (targetChanged)="targetChanged.emit()">
                </lib-boolean-property>
            
                <lib-chip-list-property
                    *ngSwitchCase="propertyType.CHIP_LIST"
                    [treeLevel]="treeLevel + 1"
                    [property]="propertyService.getAsChiplistProperty(child)"
                    [target]="childrenTarget"
                    [isSimplified]="isSimplified"
                    (remove)="onRemoveChild(i)"
                    (targetChanged)="targetChanged.emit()">
                </lib-chip-list-property>
            
                <lib-textarea-property
                    *ngSwitchCase="propertyType.TEXTAREA"
                    [treeLevel]="treeLevel + 1"
                    [property]="propertyService.getAsTextareaProperty(child)"
                    [target]="childrenTarget"
                    [isSimplified]="isSimplified"
                    (remove)="onRemoveChild(i)"
                    (targetChanged)="targetChanged.emit()">
                </lib-textarea-property>
            
                <ng-container *ngSwitchCase="propertyType.NUMBER">
                    <ng-container *ngTemplateOutlet="inputProperty"></ng-container>
                </ng-container>
                <ng-container *ngSwitchCase="propertyType.TEXT">
                    <ng-container *ngTemplateOutlet="inputProperty"></ng-container>
                </ng-container>
                <ng-template #inputProperty>
                    <lib-input-property
                        [treeLevel]="treeLevel + 1"
                        [property]="propertyService.getAsInputProperty(child)"
                        [target]="childrenTarget"
                        [isSimplified]="isSimplified"
                        (remove)="onRemoveChild(i)"
                        (targetChanged)="targetChanged.emit()">
                    </lib-input-property>
                </ng-template>
            </ng-container>
        </ng-container>
	</ng-container>
</ng-template>

<mat-menu #optionsMenu="matMenu">
    <button *ngIf="canAdd" mat-menu-item [matMenuTriggerFor]="addMenu">
        <mat-icon>add</mat-icon>
        <span>Add</span>
    </button>
    <button *ngIf="property.isRemovable" mat-menu-item color="warn" (click)="remove.emit()">
        <mat-icon>remove</mat-icon>
        <span>Remove</span>
    </button>
</mat-menu>

<mat-menu #addMenu="matMenu">
    <button mat-menu-item *ngIf="property.addOptions?.includes(propertyType.ARRAY)" [matMenuTriggerFor]="addArrayMenu">
        {{propertyType.ARRAY}}
    </button>
    <ng-container *ngFor="let type of propertyService.possibleArrayAddTypes">
        <button mat-menu-item *ngIf="property.addOptions?.includes(type)" (click)="onAddChild(type)">
            {{type}}
        </button>
    </ng-container>
</mat-menu>

<mat-menu #addArrayMenu="matMenu">
    <button *ngFor="let type of propertyService.possibleArrayAddTypes" mat-menu-item (click)="onAddChild(propertyType.ARRAY, type)">
        {{type}}
    </button>
</mat-menu>